# 一、写入操作概览

ES的写入操作有4种：

1. **Index（索引）**

- 功能：创建新文档或完全覆盖已存在的文档
- 操作类型：`OpType.INDEX`
- 核心代码位置：`org/elasticsearch/action/index`

2. **Create（创建）**

- 功能：仅当文档不存在时创建（是 Index 的特殊模式）

~~~java
public IndexRequest create(boolean create) {
        if (create) {
            return opType(OpType.CREATE);
        } else {
            return opType(OpType.INDEX);
        }
    }
~~~

- 操作类型：`OpType.CREATE`
- 如果文档已存在会失败
- 核心代码位置：`org/elasticsearch/action/index/IndexRequest.java`

3. **Update（更新）**

- 功能：部分更新文档或使用脚本更新

- 内部会转换为 Index 或 Delete 操作

  （辅助类: `org/elasticsearch/action/update/UpdateHelper.java`）

~~~java
// UpdateHelper 负责将 Update 请求转换为实际的 Index 或 Delete 操作
switch (operation) {
    case INDEX:
        final IndexRequest indexRequest = Requests.indexRequest(request.index())...
        return new Result(indexRequest, DocWriteResponse.Result.UPDATED, ...);
    case DELETE:
        DeleteRequest deleteRequest = Requests.deleteRequest(request.index())...
        return new Result(deleteRequest, DocWriteResponse.Result.DELETED, ...);
}
~~~

- 核心代码位置：`org/elasticsearch/action/update`

4. **Delete（删除）**

- 功能：删除指定文档
- 核心代码位置：`org/elasticsearch/action/delete`

**另外：Bulk（批量）**

- 功能：批量执行上述任意操作的组合
- 可以在一个请求中混合多种操作类型
- 核心代码位置：`org/elasticsearch/action/bulk`



# 二、前置知识

### **1.分布式设计**

为了支持对海量数据的存储和查询，Elasticsearch引入分片的概念，一个索引被分成多个分片，每个分片可以有一个**主分片**和**多个副本分片**，每个分片副本都是一个具有完整功能的**lucene实例**。

分片可以分配在不同的服务器上，同一个分片的不同副本不能分配在相同的服务器上

![image-20251031150730473](/Users/xieruihang.1/Documents/Notes/docs/assets/images/image-20251031150730473.png){ data-zoomable }

### **2.两种交互方式**

**2.1 RESTful API** 

**定义**：RESTful API 是通过 HTTP 请求与 Elasticsearch 服务器交互的一种方式，用户通过标准的 HTTP 方法（如 `GET`、`POST`、`PUT`、`DELETE`）来执行数据的查询、插入、更新、删除等操作。

**用途**：用于执行各种标准的操作，包括数据的索引、查询、更新和删除。它是与 Elasticsearch 进行交互的主要方式。

**2.2 Scripting（脚本）**

**定义**：Painless 是 Elasticsearch 提供的一个高效、安全的脚本语言，用于动态地执行计算、数据修改和字段处理。它是专为 Elasticsearch 优化的脚本语言，通常用于查询和更新操作中，帮助用户进行复杂的字段计算、排序或动态文档修改。

**用途**：用于在查询、更新、聚合等操作中动态计算值、修改字段或自定义逻辑。它特别适合用于 **动态计算字段** 或 **自定义排序/过滤** 等场景。

**2.3 RESTful API 与脚本的适用场景（写入）**

| 操作         | RESTful API 用法               | 脚本用法                 |
| ------------ | ------------------------------ | ------------------------ |
| **`index`**  | 插入新文档（如果 ID 不存在）   | 不常用脚本               |
| **`create`** | 创建新文档（文档存在时会报错） | 不常用脚本               |
| **`update`** | 更新文档，部分更新             | 常用，修改字段、动态计算 |
| **`delete`** | 删除文档                       | 不常用脚本               |
| **`bulk`**   | 批量操作（插入、更新、删除）   | 常用，批量更新或条件计算 |

+ 对于 **简单的插入、删除和更新操作**，使用 **RESTful API** 是最直接的方式。

+ 对于需要 **动态修改字段、计算值、或在批量操作中使用计算逻辑** 的情况，使用 **脚本** 会更加灵活。



# 三、ES的写入流程

### 1.整体流程

~~~
HTTP 请求
    ↓
【REST 层】RestIndexAction / RestUpdateAction / RestDeleteAction
    ↓ prepareRequest() - 解析 HTTP 请求，生成 Request 对象
    ↓
【Transport 层】TransportIndexAction / TransportUpdateAction / TransportDeleteAction
    ↓ execute() / doExecute() - 验证、路由、协调
    ↓
【Shard 层】TransportShardBulkAction
    ↓ 在具体分片上执行操作
    ↓
【Engine 层】InternalEngine
    ↓ 执行 Lucene 操作
    ↓
Lucene 索引
~~~

































参考：

[深入理解Elasticsearch写入过程](https://elasticsearch.cn/article/13533)

[一起学Elasticsearch系列-写入原理](https://zhuanlan.zhihu.com/p/675426339)
